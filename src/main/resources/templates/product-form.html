<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title th:text="${product.id != null ? '编辑商品' : '新增商品'}">商品表单</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/product-form.css}">
</head>

<body>
    <div class="header">
        <h1 th:text="${product.id != null ? '编辑商品' : '新增商品'}">商品表单</h1>
    </div>

    <div class="container">
        <a th:href="@{/products}" class="back-link">← 返回商品列表</a>

        <div class="form-container">
            <h2 class="form-title" th:text="${product.id != null ? '编辑商品信息' : '添加新商品'}">商品表单</h2>

            <form th:action="@{/products/save}" method="post">
                <input type="hidden" name="id" th:value="${product.id}">

                <div class="form-group">
                    <label for="name">
                        商品名称 <span class="required">*</span>
                    </label>
                    <input type="text" id="name" name="name" th:value="${product.name}" required>
                </div>

                <div class="form-group">
                    <label for="categoryId">
                        商品分类 <span class="required">*</span>
                    </label>
                    <div class="category-select-wrapper">
                        <select id="categoryId" name="categoryId" required>
                            <option value="">请选择分类</option>
                            <option th:each="category : ${categories}" th:value="${category.id}"
                                th:text="${category.name}"
                                th:selected="${product.category != null && product.category.id == category.id}">
                            </option>
                        </select>
                        <button type="button" class="btn btn-info btn-sm" onclick="showNewCategoryModal()">+
                            新建分类</button>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="price">
                            价格 <span class="required">*</span>
                        </label>
                        <input type="number" id="price" name="price" th:value="${product.price}" step="1" min="0"
                            required>
                        <div class="help-text">请输入商品价格（单位：元）</div>
                    </div>

                    <div class="form-group">
                        <label for="stockQuantity">
                            库存数量 <span class="required">*</span>
                        </label>
                        <input type="number" id="stockQuantity" name="stockQuantity" th:value="${product.stockQuantity}"
                            min="0" required>
                        <div class="help-text">请输入库存数量</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">
                        商品描述
                    </label>
                    <textarea id="description" name="description" th:text="${product.description}"></textarea>
                    <div class="help-text">可以输入商品的详细描述信息</div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">保存</button>
                    <a th:href="@{/products}" class="btn btn-secondary">取消</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for new category -->
    <div id="newCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>新建分类</h3>
                <button type="button" class="modal-close" onclick="hideNewCategoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newCategoryName">
                        分类名称 <span class="required">*</span>
                    </label>
                    <input type="text" id="newCategoryName" maxlength="100" required>
                </div>
                <div class="form-group">
                    <label for="newCategoryDescription">
                        分类描述
                    </label>
                    <textarea id="newCategoryDescription" maxlength="255"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideNewCategoryModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="createNewCategory()">创建</button>
            </div>
        </div>
    </div>

    <script>
        function showNewCategoryModal() {
            document.getElementById('newCategoryModal').classList.add('show');
        }

        function hideNewCategoryModal() {
            document.getElementById('newCategoryModal').classList.remove('show');
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryDescription').value = '';
        }

        function createNewCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            const description = document.getElementById('newCategoryDescription').value.trim();

            if (!name) {
                alert('请输入分类名称');
                return;
            }

            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="_csrf"]');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]');

            const formData = new FormData();
            formData.append('name', name);
            formData.append('description', description);
            if (csrfToken && csrfHeader) {
                formData.append('_csrf', csrfToken.getAttribute('content'));
            }

            fetch('/categories/quick-add', {
                method: 'POST',
                headers: csrfHeader && csrfToken ? {
                    [csrfHeader.getAttribute('content')]: csrfToken.getAttribute('content')
                } : {},
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text); });
                    }
                    return response.json();
                })
                .then(category => {
                    // Add new category to select
                    const select = document.getElementById('categoryId');
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.text = category.name;
                    option.selected = true;
                    select.appendChild(option);

                    hideNewCategoryModal();
                    alert('分类创建成功！');
                })
                .catch(error => {
                    alert('创建失败：' + error.message);
                });
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('newCategoryModal');
            if (event.target === modal) {
                hideNewCategoryModal();
            }
        }
    </script>
</body>

</html>